import{_ as t}from"./CaNb7KN_.js";import{c,w as r,o as p,a as s,b as l}from"./Du-K4N_a.js";const u={__name:"es-modules-in-browsers",setup(o){const n={title:"[译] 浏览器中的 ES6 module 实现",description:"浏览器中的 ES6 module 实现",keywords:"翻译,ES6",pathname:"es-modules-in-browsers",translation:{author:"@Jake Archibald",social:"https://jakearchibald.com/",from:"https://jakearchibald.com/2017/es-modules-in-browsers/"},create_time:"2017-05-06",prev:{title:"Chrome 中的 “Tab to Search” 与 Open Search",pathname:"opensearch"},next:{title:"Facebook 开源代码优化工具 Prepack",pathname:"prepack"}};return(h,a)=>{const e=t;return p(),c(e,{data:n},{default:r(()=>[...a[0]||(a[0]=[s("p",null,"ES6 的模块特性（module） 开始在浏览器端实现啦！一切正在路上...",-1),s("table",null,[s("thead",null,[s("tr",null,[s("th",null,"浏览器"),s("th",null,"备注")])]),s("tbody",null,[s("tr",null,[s("td",null,"Safari 10.1"),s("td",null,"(无)")]),s("tr",null,[s("td",null,"Chrome Canary 60"),s("td",null,[l("打开 "),s("code",null,"chrome:flags"),l(" 启用“实验性网络平台功能”")])]),s("tr",null,[s("td",null,"Firefox 54"),s("td",null,[l("打开 "),s("code",null,"about:config"),l(" 启用 "),s("code",null,"dom.moduleScripts.enabled")])]),s("tr",null,[s("td",null,"Edge 15"),s("td",null,[l("打开 "),s("code",null,"about:flags"),l(" 启用“实验性 JavaScript 功能”")])])])],-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(">")]),s("span",{class:"language-javascript"},[l(`
  `),s("span",{class:"hljs-keyword"},"import"),l(" {addTextToBody} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'./utils.js'"),l(`;

  `),s("span",{class:"hljs-title function_"},"addTextToBody"),l("("),s("span",{class:"hljs-string"},"'Modules are pretty cool.'"),l(`);
`)]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("pre",null,[s("code",{class:"hljs lang-javascript"},[s("span",{class:"hljs-comment"},"// utils.js"),l(`
`),s("span",{class:"hljs-keyword"},"export"),l(),s("span",{class:"hljs-keyword"},"function"),l(),s("span",{class:"hljs-title function_"},"addTextToBody"),l("("),s("span",{class:"hljs-params"},"text"),l(`) {
  `),s("span",{class:"hljs-keyword"},"const"),l(" div = "),s("span",{class:"hljs-variable language_"},"document"),l("."),s("span",{class:"hljs-title function_"},"createElement"),l("("),s("span",{class:"hljs-string"},"'div'"),l(`);
  div.`),s("span",{class:"hljs-property"},"textContent"),l(` = text;
  `),s("span",{class:"hljs-variable language_"},"document"),l("."),s("span",{class:"hljs-property"},"body"),l("."),s("span",{class:"hljs-title function_"},"appendChild"),l(`(div);
}
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://cdn.rawgit.com/jakearchibald/a298d5af601982c338186cd355e624a8/raw/aaa2cbee9a5810d14b01ae965e52ecb9b2965a44/",target:"_blank",rel:"noopener"},"Live demo")]),l("。")],-1),s("p",null,[l("只需为 "),s("code",null,"script"),l(" 元素添加 "),s("code",null,"type=module"),l(" 属性，浏览器就会把该元素对应的内联脚本或外部脚本当成 ECMAScript 模块进行处理。")],-1),s("p",null,[l("目前已经有一些 "),s("a",{href:"https://ponyfoo.com/articles/es6-modules-in-depth",target:"_blank",rel:"noopener"},"很棒的关于 ECMAScript 模块的文章"),l("了，不过我还是想分享一些和浏览器相关的东西，它们都是我在测试代码、阅读规范的过程中学习到的。")],-1),s("h2",null,"尚未得到支持的 import 路径符号",-1),s("pre",null,[s("code",{class:"hljs lang-javascript"},[s("span",{class:"hljs-comment"},"// 支持"),l(`
`),s("span",{class:"hljs-keyword"},"import"),l(" {foo} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'https://jakearchibald.com/utils/bar.js'"),l(`;
`),s("span",{class:"hljs-keyword"},"import"),l(" {foo} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'/utils/bar.js'"),l(`;
`),s("span",{class:"hljs-keyword"},"import"),l(" {foo} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'./bar.js'"),l(`;
`),s("span",{class:"hljs-keyword"},"import"),l(" {foo} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'../bar.js'"),l(`;

`),s("span",{class:"hljs-comment"},"// 不支持"),l(`
`),s("span",{class:"hljs-keyword"},"import"),l(" {foo} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'bar.js'"),l(`;
`),s("span",{class:"hljs-keyword"},"import"),l(" {foo} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'utils/bar.js'"),l(`;
`)])],-1),s("p",null,"有效的路径符号应当符合以下条件规则之一：",-1),s("ul",null,[s("li",null,[l("完整的非相对路径。这样在将其传给"),s("code",null,"new URL(moduleSpecifier)"),l("的时候才不会报错。")]),s("li",null,[l("以 "),s("code",null,"/"),l(" 开头。")]),s("li",null,[l("以 "),s("code",null,"./"),l(" 开头。")]),s("li",null,[l("以 "),s("code",null,"../"),l(" 开头。")])],-1),s("p",null,"其他形式的符号被保留下来，未来将用于其他功能（如引入[import]内置模块）。",-1),s("h2",null,[l("使用 "),s("code",null,"nomodule"),l(" 属性向后兼容")],-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"module.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"nomodule"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"fallback.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://cdn.rawgit.com/jakearchibald/6110fb6df717ebca44c2e40814cc12af/raw/7fc79ed89199c2512a4579c9a3ba19f72c219bd8/",target:"_blank",rel:"noopener"},"Live demo")]),l("。")],-1),s("p",null,[l("支持 "),s("code",null,"type=module"),l(" 的浏览器将会忽略带有 "),s("code",null,"nomodule"),l(" 属性的 "),s("code",null,"script"),l(" 标签。这意味着我们可以为支持模块的浏览器提供模块形式的代码，同时为那些不支持模块的浏览器提供降级处理。")],-1),s("h3",null,"浏览器 issue",-1),s("ul",null,[s("li",null,[l("Firefox 暂不支持 "),s("code",null,"nomodule"),l(" ("),s("a",{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1330900",target:"_blank",rel:"noopener"},"issue"),l(")。")]),s("li",null,[l("Edge 暂不支持 "),s("code",null,"nomodule"),l(" ("),s("a",{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/10525830/",target:"_blank",rel:"noopener"},"issue"),l(")。")]),s("li",null,[l("Safari 10.1 暂不支持 "),s("code",null,"nomodule"),l("，但在最新的技术预览版中已经解决了此问题。对于 10.1 来说，有一个"),s("a",{href:"https://gist.github.com/samthor/64b114e4a4f539915a95b91ffd340acc",target:"_blank",rel:"noopener"},"相当棒的解决方案"),l("。")])],-1),s("h2",null,"默认延迟执行",-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-comment"},"<!-- 这个脚本会在… -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- …这个脚本之后、… -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"2.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- …这个脚本之前执行。 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"defer"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"3.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://cdn.rawgit.com/jakearchibald/d6808ea2665f8b3994380160dc2c0bc1/raw/c0a194aa70dda1339c960c6f05b2e16988ee66ac/",target:"_blank",rel:"noopener"},"Live demo")]),l("。脚本执行顺序为 "),s("code",null,"2.js"),l(", "),s("code",null,"1.js"),l(", "),s("code",null,"3.js"),l("。")],-1),s("p",null,[l("获取脚本会导致 HTML parser 阻塞，这简直太太太太恶心了。对正常的脚本，我们可以使用 "),s("code",null,"defer"),l(" 属性来防止阻塞，脚本将延迟至文档解析完毕后执行，同时保持与其他使用 "),s("code",null,"defer"),l(" 的脚本之间的执行顺序。模块脚本的默认行为与 "),s("code",null,"defer"),l(" 相同 —— 无法使模块脚本阻塞 HTML parser。")],-1),s("p",null,[l("模块脚本与使用 "),s("code",null,"defer"),l(" 的正常脚本使用相同的执行队列。")],-1),s("h2",null,"内联脚本同样延迟",-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-comment"},"<!-- 这个脚本会在… -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(">")]),s("span",{class:"language-javascript"},[l(`
  `),s("span",{class:"hljs-title function_"},"addTextToBody"),l("("),s("span",{class:"hljs-string"},'"Inline module executed"'),l(`);
`)]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- …这个脚本… -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- …以及这个脚本之后、… -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"defer"),l(">")]),s("span",{class:"language-javascript"},[l(`
  `),s("span",{class:"hljs-title function_"},"addTextToBody"),l("("),s("span",{class:"hljs-string"},'"Inline script executed"'),l(`);
`)]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- …这个脚本之前执行。 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"defer"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"2.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://cdn.rawgit.com/jakearchibald/7026f72c0675898196f7669699e3231e/raw/fc7521aabd9485f30dbd5189b407313cd350cf2b/",target:"_blank",rel:"noopener"},"Live demo")]),l("。执行顺序依次为 "),s("code",null,"1.js"),l("、内联脚本、内联模块、"),s("code",null,"2.js"),l("。")],-1),s("p",null,[l("正常的内联脚本会忽略 "),s("code",null,"defer"),l(" 属性，而内联模块则总是延迟执行，无论是否引入其他内容。")],-1),s("h2",null,[s("code",null,"async"),l(" 对内联、外部模块同样适用")],-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-comment"},"<!-- 脚本将会在其引入的模块加载完成后立即执行 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"async"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(">")]),s("span",{class:"language-javascript"},[l(`
  `),s("span",{class:"hljs-keyword"},"import"),l(" {addTextToBody} "),s("span",{class:"hljs-keyword"},"from"),l(),s("span",{class:"hljs-string"},"'./utils.js'"),l(`;

  `),s("span",{class:"hljs-title function_"},"addTextToBody"),l("("),s("span",{class:"hljs-string"},"'Inline module executed.'"),l(`);
`)]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- 脚本及其引入的模块加载完成后立即执行 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"async"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://module-script-tests-rgjnxtrtqq.now.sh/async",target:"_blank",rel:"noopener"},"Live demo")]),l("。先完成加载的脚本先执行。")],-1),s("p",null,[l("与正常脚本相同，带有 "),s("code",null,"async"),l(" 属性的脚本在下载时不会阻塞 HTML parser，一旦加载完毕，立即执行。不同的是，"),s("code",null,"async"),l(" 对内联模块也同样适用。")],-1),s("p",null,[l("使用 "),s("code",null,"async"),l(" 时，脚本的执行顺序可能会和它们在 DOM 中出现的顺序不尽相同。")],-1),s("h3",null,"浏览器 issue",-1),s("ul",null,[s("li",null,[l("Firefox 不支持内联模块使用 "),s("code",null,"async"),l("("),s("a",{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1361369",target:"_blank",rel:"noopener"},"issue"),l(")。")])],-1),s("h2",null,"模块只执行一次",-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-comment"},"<!-- 1.js 只执行一次 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(">")]),s("span",{class:"language-javascript"},[l(`
  `),s("span",{class:"hljs-keyword"},"import"),l(),s("span",{class:"hljs-string"},'"./1.js"'),l(`;
`)]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- 普通脚本会执行多次 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"2.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"2.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://cdn.rawgit.com/jakearchibald/f7f6d37ef1b4d8a4f908f3e80d50f4fe/raw/1fcedde007a2b90049a7ea438781aebe69e22762/",target:"_blank",rel:"noopener"},"Live demo")]),l("。")],-1),s("p",null,"引入同一个模块多次的时候，模块只会执行一次。这对 HTML 中的模块脚本同样适用 —— 在同一个页面中，URL 相同的模块只会执行一次。",-1),s("h3",null,"浏览器 issue",-1),s("ul",null,[s("li",null,[l("Edge 会执行多次 ("),s("a",{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865922/",target:"_blank",rel:"noopener"},"issue"),l(")。")])],-1),s("h2",null,"总是使用 CORS",-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-comment"},"<!-- 模块不会执行，因其未通过 CORS 检查 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"https://….now.sh/no-cors"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- 模块不会执行，因其引入的脚本未通过 CORS 检查 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(">")]),s("span",{class:"language-javascript"},[l(`
  `),s("span",{class:"hljs-keyword"},"import"),l(),s("span",{class:"hljs-string"},"'https://….now.sh/no-cors'"),l(`;

  `),s("span",{class:"hljs-title function_"},"addTextToBody"),l("("),s("span",{class:"hljs-string"},'"This will not execute."'),l(`);
`)]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- CORS 检查通过，模块将会执行 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"https://….now.sh/cors"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://cdn.rawgit.com/jakearchibald/2b8d4bc7624ca6a2c7f3c35f6e17fe2d/raw/fe04e60b0b7021f261e79b8ef28b0ccd132c1585/",target:"_blank",rel:"noopener"},"Live demo")]),l("。")],-1),s("p",null,[l("与正常脚本不同，模块脚本（及其引入的脚本）是通过 CORS 获取的。这意味着，跨域模块脚本必须返回类似 "),s("code",null,"Access-Control-Allow-Origin: *"),l(" 这样的有效的响应头。")],-1),s("h3",null,"浏览器 issue",-1),s("ul",null,[s("li",null,[l("Firefox 无法加载 demo 页面("),s("a",{href:"https://bugzilla.mozilla.org/show_bug.cgi?id=1361373",target:"_blank",rel:"noopener"},"issue"),l(")。")]),s("li",null,[l("Edge 加载了没有 CORS 响应头的模块("),s("a",{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865934/",target:"_blank",rel:"noopener"},"issue"),l(")。")])],-1),s("h2",null,"不携带凭证信息",-1),s("pre",null,[s("code",{class:"hljs lang-html"},[s("span",{class:"hljs-comment"},"<!-- 请求脚本时会携带相关凭证 (如 cookie) -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- 不会携带相关凭证 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- 会携带相关凭证 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"crossorigin"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"1.js?"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- 不会携带相关凭证 -->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"crossorigin"),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"https://other-origin/1.js"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`

`),s("span",{class:"hljs-comment"},"<!-- 会携带相关凭证-->"),l(`
`),s("span",{class:"hljs-tag"},[l("<"),s("span",{class:"hljs-name"},"script"),l(),s("span",{class:"hljs-attr"},"type"),l("="),s("span",{class:"hljs-string"},'"module"'),l(),s("span",{class:"hljs-attr"},"crossorigin"),l("="),s("span",{class:"hljs-string"},'"use-credentials"'),l(),s("span",{class:"hljs-attr"},"src"),l("="),s("span",{class:"hljs-string"},'"https://other-origin/1.js?"'),l(">")]),s("span",{class:"hljs-tag"},[l("</"),s("span",{class:"hljs-name"},"script"),l(">")]),l(`
`)])],-1),s("p",null,[s("strong",null,[s("a",{href:"https://module-script-tests-zoelmqooyv.now.sh/cookie-page",target:"_blank",rel:"noopener"},"Live demo")]),l("。")],-1),s("p",null,[l("在请求同源的情况下，多数基于 CORS 的 API 都会发送凭证信息（credentials，如 Cookie）。但 "),s("code",null,"fetch()"),l(" 和模块脚本恰恰例外 —— 除非手动声明，否则是不会发送相关凭证的。")],-1),s("p",null,[l("对于一个同源的模块脚本，可以为其添加 "),s("code",null,"crossorigin"),l(" 属性（这看起来挺怪的，我已经在规范中提出这个"),s("a",{href:"https://github.com/whatwg/html/issues/2557",target:"_blank",rel:"noopener"},"问题"),l("了），这样在请求时就可以携带相关凭证了。如果你还想将凭证发给其他域，请使用 "),s("code",null,'crossorigin="use-credentials"'),l("。需要注意的是，接收凭证的域必须返回 "),s("code",null,"Access-Control-Allow-Credentials: true"),l(" 的响应头。")],-1),s("p",null,"此外，还有一个与“模块只会执行一次”这条规则相关的问题。浏览器是通过 URL 来区别不同模块的，所以如果你先请求了一个模块而不携带任何凭证，紧接着又携带凭证信息去请求该模块，那么第二次得到的依然是不携带凭证的请求所返回的模块。这正是我在上面代码中的 URL 后面加上“?”的原因。",-1),s("h3",null,"浏览器 issue",-1),s("ul",null,[s("li",null,[l("请求同源模块时，Chrome 会携带凭证信息("),s("a",{href:"https://bugs.chromium.org/p/chromium/issues/detail?id=717525",target:"_blank",rel:"noopener"},"issue"),l(")。")]),s("li",null,[l("即使添加了 "),s("code",null,"crossorigin"),l(" 属性，Safari 在请求同源脚本时也不会携带凭证信息("),s("a",{href:"https://bugs.webkit.org/show_bug.cgi?id=171550",target:"_blank",rel:"noopener"},"issue"),l(")。")]),s("li",null,[l("Edge 则完全弄反了。请求同源模块时，Edge 默认会发送凭证信息，但如果手动添加了 "),s("code",null,"crossorigin"),l(" 属性，则又不会携带 ("),s("a",{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865956/",target:"_blank",rel:"noopener"},"issue"),l(")。")])],-1),s("p",null,"Firefox 是唯一正确实现这一点的浏览器 —— 好样的！",-1),s("h2",null,"Mime-types",-1),s("p",null,[l("不同于普通脚本，对于通过 module 引入的脚本，服务器必须返回"),s("a",{href:"https://html.spec.whatwg.org/multipage/scripting.html#javascript-mime-type",target:"_blank",rel:"noopener"},"合法的 MIME type"),l("，否则脚本将不会执行。")],-1),s("p",null,[s("strong",null,[s("a",{href:"https://module-script-tests-zoelmqooyv.now.sh/mime",target:"_blank",rel:"noopener"},"Live demo")]),l("。")],-1),s("h3",null,"浏览器 issue",-1),s("ul",null,[s("li",null,[l("Edge 仍将执行 MIME type 非法的脚本("),s("a",{href:"https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/11865977/",target:"_blank",rel:"noopener"},"issue"),l(")。")])],-1),s("hr",null,null,-1),s("p",null,"以上就是我目前所学习到的所有内容。浏览器开始支持 ES6 模块，简直太开心啦~",-1)])]),_:1})}}};export{u as default};
