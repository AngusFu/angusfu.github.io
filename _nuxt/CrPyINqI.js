import{_ as l}from"./Bm2Oy-cY.js";import{c as r,w as o,o as i,a as e,b as s}from"./YobvFIQM.js";const u={__name:"app-with-react-native",setup(c){const n={title:"react-native 开发 App 手记",description:"react-native 开发 App 手记",keywords:"原创,react-native,开发心得",pathname:"app-with-react-native",translation:null,create_time:"2016-04-22",prev:{title:"[译] No WebSockets Over HTTP2",pathname:"no-websockets-over-http2"},next:{title:"近来在Firefox上遇到的一些坑",pathname:"problems-with-firefox"}};return(p,a)=>{const t=l;return i(),r(t,{data:n},{default:o(()=>[...a[0]||(a[0]=[e("p",null,[s("做了一个月的 "),e("code",null,"RN"),s("。")],-1),e("p",null,"遇到一些问题，陆续记录下来。一些关于组件上的问题不细说了。",-1),e("h2",null,"Android 下的键盘事件监听",-1),e("p",null,[s("一直想找安卓下面的键盘事件，可是官方文档（0.22）压根就没提这档子事啊。唯一稍微有点眉目的，就是关于"),e("a",{href:"http://reactnative.cn/docs/0.22/native-modules-android.html#%E5%8F%91%E9%80%81%E4%BA%8B%E4%BB%B6%E5%88%B0javascript",target:"_blank",rel:"noopener"},"原生模块"),s("这里。")],-1),e("p",null,[s("后来看到了 "),e("a",{href:"https://github.com/Andr3wHur5t/react-native-keyboard-spacer/blob/master/KeyboardSpacer.js",target:"_blank",rel:"noopener"},"react-native-keyboard-spacer"),s(" 这个组件的写法，很傻很天真的以为是需要使用什么 "),e("code",null,"java"),s(" 或 "),e("code",null,"OC"),s(" 的支持。")],-1),e("p",null,[s("于是我决定去看看源码，找到所有含有 "),e("code",null,"keyboard"),s(" 的 "),e("code",null,"java"),s(" 文件。这么一找，还真找到了。")],-1),e("pre",null,[e("code",{class:"hljs lang-java"},[s(`
`),e("span",{class:"hljs-keyword"},"if"),s(` (mKeyboardHeight != heightDiff && heightDiff > mMinKeyboardHeightDetected) {
    `),e("span",{class:"hljs-comment"},"// keyboard is now showing, or the keyboard height has changed"),s(`
    mKeyboardHeight = heightDiff;
    `),e("span",{class:"hljs-type"},"WritableMap"),s(),e("span",{class:"hljs-variable"},"params"),s(),e("span",{class:"hljs-operator"},"="),s(` Arguments.createMap();
    `),e("span",{class:"hljs-type"},"WritableMap"),s(),e("span",{class:"hljs-variable"},"coordinates"),s(),e("span",{class:"hljs-operator"},"="),s(` Arguments.createMap();
    coordinates.putDouble(`),e("span",{class:"hljs-string"},'"screenY"'),s(`, PixelUtil.toDIPFromPixel(mVisibleViewArea.bottom));
    coordinates.putDouble(`),e("span",{class:"hljs-string"},'"screenX"'),s(`, PixelUtil.toDIPFromPixel(mVisibleViewArea.left));
    coordinates.putDouble(`),e("span",{class:"hljs-string"},'"width"'),s(`, PixelUtil.toDIPFromPixel(mVisibleViewArea.width()));
    coordinates.putDouble(`),e("span",{class:"hljs-string"},'"height"'),s(`, PixelUtil.toDIPFromPixel(mKeyboardHeight));
    params.putMap(`),e("span",{class:"hljs-string"},'"endCoordinates"'),s(`, coordinates);
    sendEvent(`),e("span",{class:"hljs-string"},'"keyboardDidShow"'),s(`, params);
} `),e("span",{class:"hljs-keyword"},"else"),s(),e("span",{class:"hljs-keyword"},"if"),s(" (mKeyboardHeight != "),e("span",{class:"hljs-number"},"0"),s(` && heightDiff <= mMinKeyboardHeightDetected) {
    `),e("span",{class:"hljs-comment"},"// keyboard is now hidden"),s(`
    mKeyboardHeight = `),e("span",{class:"hljs-number"},"0"),s(`;
    sendEvent(`),e("span",{class:"hljs-string"},'"keyboardDidHide"'),s(", "),e("span",{class:"hljs-literal"},"null"),s(`);
}
`)])],-1),e("p",null,[s("嗯，安卓下的事件就在这里了。"),e("code",null,"keyboardDidShow"),s(" 和 "),e("code",null,"keyboardDidHide"),s("。")],-1),e("p",null,[s("看来 "),e("a",{href:"https://github.com/Andr3wHur5t/react-native-keyboard-spacer/blob/master/KeyboardSpacer.js",target:"_blank",rel:"noopener"},"react-native-keyboard-spacer"),s(" 还是很靠谱的。于是从其中抽取了键盘的逻辑，做成了 "),e("a",{href:"https://github.com/AngusFu/react-native-keyboard-event",target:"_blank",rel:"noopener"},"react-native-keyboard-event"),s(" 这个组件。可以使用 "),e("code",null,"npm"),s(" 来安装。")],-1),e("pre",null,[e("code",{class:"hljs lang-javascript"},[s(`
`),e("span",{class:"hljs-keyword"},"import"),s(),e("span",{class:"hljs-title class_"},"KeyListener"),s(),e("span",{class:"hljs-keyword"},"from"),s(),e("span",{class:"hljs-string"},"'react-native-keyboard-event'"),s(`;
`),e("span",{class:"hljs-title class_"},"KeyListener"),s("."),e("span",{class:"hljs-title function_"},"show"),s("(onkeyboardShow)."),e("span",{class:"hljs-title function_"},"hide"),s(`(onkeyboardHide);
`),e("span",{class:"hljs-comment"},"// Note"),s(`
`),e("span",{class:"hljs-comment"},"// event name is up to platform"),s(`
`),e("span",{class:"hljs-title class_"},"KeyListener"),s("."),e("span",{class:"hljs-property"},"hideEvent"),s(`;
`),e("span",{class:"hljs-title class_"},"KeyListener"),s("."),e("span",{class:"hljs-property"},"showEvent"),s(`;
`)])],-1),e("h2",null,"fetch 方法",-1),e("p",null,[e("code",null,"fetch"),s(" 方法调用最好加上 "),e("code",null,"done"),s(" 方法，否则有时候会报错。")],-1),e("h2",null,"RN 请求数量限制",-1),e("p",null,"网络请求数量需要做限制。不能无限请求，否则请求都会被阻塞一直发布出去。",-1),e("p",null,[s("为什么会遇到这种情况呢？因为底层有个死循环，四秒钟查找一次，是否有未上传的记录，若有则会通知前端上传，前端上传结果会反馈给底层。最后出现同一条记录反复通知反复失败的情况。通过分析日志，发现前端接到了通知，但 "),e("code",null,"fetch"),s(" 成功、失败的逻辑都没进去。")],-1),e("p",null,"最后的解决办法，很简单，底层对请求数量做限制。",-1),e("p",null,"To be continued...",-1)])]),_:1})}}};export{u as default};
